<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <title>五、C++修改Lua的变量和Table的值</title>
        <link rel="stylesheet" type="text/css" media="all" href="../../../style.css">
    </head>
    <body class="post-template-default single single-post postid-14 single-format-standard logged-in admin-bar single-author singular two-column left-sidebar customize-support">
        <div id="page" class="hfeed">
            <div id="main">
                <div id="primary">
                    <div id="content" role="main">        
                        <article id="post-14" class="post-14 post type-post status-publish format-standard hentry category-18">
                            <header class="entry-header">
                                <h1 class="entry-title">五、C++修改Lua的变量和Table的值</h1>
                            </header>
                            <div class="entry-content">
<br><a href="../../../index.html"> Home </a> 
<p data-pid="VLkDwHPQ">上一篇文章讲了C++如何获得Lua中的变量和Table中的值，这篇文章主要讲如何修改Lua中的变量的值和Table中的变量的值，并把修改后的值打印出来。</p><h2>一、直接上代码：</h2><p data-pid="ZE8DNx0O"><b>1、在Test.lua文件内添加如下代码：</b></p><pre><p data-pid="Jr1ryb-U">print &#34;Hello, Lua Demo5&#34;<br/></p><p data-pid="LxQffPBq">name=&#34;my name is lua&#34;</p><p data-pid="YxfeFd3E">iVar = 5</p><p data-pid="kG8xaVfN">nameTable={sex = &#34;male&#34;, age=18}</p><p class="ztext-empty-paragraph"><br/></p><p data-pid="_gD8y9U8">function PrintLuaLog()</p><p data-pid="ou5HaYMT">	print(&#34;name: &#34; ..name)</p><p data-pid="KA-LVAXE">	print(&#34;iVar: &#34; ..iVar)</p><p class="ztext-empty-paragraph"><br/></p><p data-pid="611XBpSf">	for key, value in pairs(nameTable) do</p><p data-pid="S1HAgVeN">		print(&#34;key: &#34;..key .. &#34;  value: &#34;.. value)</p><p data-pid="4fd5nIcj">	end</p><p data-pid="Uv9je3V1">end</p><p class="ztext-empty-paragraph"><br/></p><p data-pid="H6GUyypt">function AddIncrease()</p><p data-pid="_vD-E2IA">	iVar = iVar + 10</p><p data-pid="nK-mi2tU">	nameTable.age = nameTable.age + 10</p><p data-pid="RkTDD5fj">end</p><p class="ztext-empty-paragraph"><br/></p><p data-pid="nixqm3AP">PrintLuaLog()</p><p data-pid="HlrswwOK">print(&#34;//////////////////////////////////////////do lua end&#34;)</p></pre><p data-pid="_-zZ7HFI"><b>2、在LuaTest.cpp文件内添加如下代码：</b></p><pre><p data-pid="k3TxM0OS">int main(int argc, char *argv[])</p><p data-pid="Xr_yiwbD">{</p><p data-pid="Zd_VIn1t">	L = lua_open();</p><p data-pid="JGP1thDa">	luaL_openlibs(L);<br/></p><p data-pid="oFLdNa9X">	luaL_dofile(L, &#34;Test.lua&#34;);</p><p class="ztext-empty-paragraph"><br/></p><p data-pid="DbFKXihn">	lua_getglobal(L, &#34;name&#34;);</p><p data-pid="QchR6B_O">	const char* strName = lua_tostring(L, -1);</p><p data-pid="0G2PmV8Q">	printf(&#34;name: %s\n&#34;, strName);</p><p class="ztext-empty-paragraph"><br/></p><p data-pid="JQNGMzwU">	StackDump(L, 1);</p><p data-pid="kUd50HGj">//code1</p><p data-pid="Pk5n4qSe">	lua_pop(L, 1);</p><p data-pid="sIGocpbn">//code2</p><p data-pid="21hL6frU">	lua_pushstring(L, &#34;my name is lua modify &#34;);</p><p data-pid="id5jEgiy">	lua_setfield(L, LUA_GLOBALSINDEX, &#34;name&#34;);</p><p data-pid="x84SDpDv">	StackDump(L, 2);</p><p data-pid="qA7hs7vj">//code3</p><p data-pid="Vh5pesXD">	lua_getglobal(L, &#34;name&#34;);</p><p data-pid="IOKz01DT">	StackDump(L, 3);</p><p data-pid="HY6dv-B2">	printf(&#34;setglobal name: %s\n&#34;, lua_tostring(L, -1));</p><p data-pid="Uh54cWit">//code4</p><p data-pid="ESA5db-q">	lua_settop(L, 0);</p><p data-pid="CGEyrh3p">//code5</p><p data-pid="XJcnN9-z">	lua_getglobal(L, &#34;nameTable&#34;);</p><p data-pid="NywLIYMQ">//code6</p><p data-pid="UFYJYaLD">	//lua_pushstring(L, &#34;sex&#34;);</p><p data-pid="DwrOcvR_">	//lua_gettable(L, -2);</p><p class="ztext-empty-paragraph"><br/></p><p data-pid="j-oVhka0">	//lua_pushstring(L, &#34;age&#34;);</p><p data-pid="Ez8fE9RT">	//lua_gettable(L, -3);</p><p data-pid="vcWXN0-0">//code7</p><p data-pid="7aV5RJJB">	lua_getfield(L, -1, &#34;sex&#34;);</p><p data-pid="VFvkdXvj">	lua_getfield(L, -2, &#34;age&#34;);</p><p class="ztext-empty-paragraph"><br/></p><p data-pid="jGa1MEGN">	StackDump(L, 4);</p><p class="ztext-empty-paragraph"><br/></p><p data-pid="786jXGk2">	printf(&#34;age: %d\n&#34;, lua_tointeger(L, -1));</p><p data-pid="jnw-u3tp">	printf(&#34;sex: %s\n&#34;, lua_tostring(L, -2));</p><p data-pid="1eTHiN3Z">//code8</p><p data-pid="F8Q9yxmx">	//lua_pushstring(L, &#34;age&#34;);</p><p data-pid="d8Wwl4m9">	//lua_pushnumber(L, 19);</p><p data-pid="-wKLYerr">	//lua_settable(L, 1);</p><p data-pid="9YOIteny">//code9</p><p data-pid="S0clAnGs">	lua_pushnumber(L, 19);</p><p data-pid="Z7FVL-0n">	lua_setfield(L, 1, &#34;age&#34;);</p><p data-pid="7QwNhPrN">//code10</p><p data-pid="Uq7IdSUc">	//lua_pushstring(L, &#34;age&#34;);</p><p data-pid="gRkAld6K">	//lua_gettable(L, 1);	</p><p data-pid="68Wk6Pe_">code11</p><p data-pid="AiQzKct3">	lua_getfield(L, 1, &#34;age&#34;);</p><p class="ztext-empty-paragraph"><br/></p><p data-pid="ms8cQN8X">	StackDump(L, 5);</p><p data-pid="LtaCJyIy">	printf(&#34;setglobal age: %d\n&#34;, (int)lua_tointeger(L, -1));</p><p data-pid="XhjNr5mS">//code12</p><p data-pid="qNtEMZfI">	lua_getglobal(L, &#34;PrintLuaLog&#34;);</p><p data-pid="HjuEgw5Y">	lua_pcall(L, 0, 0, 0);</p><p data-pid="en68GA3r">	StackDump(L, 6);</p><p data-pid="Y-XnCWrB">//code13</p><p data-pid="VObTMrYf">	lua_getglobal(L, &#34;AddIncrease&#34;);</p><p data-pid="OXmkcY-7">	lua_pcall(L, 0, 0, 0);</p><p data-pid="EexOzhgZ">//code14</p><p data-pid="ZMrkDKeu">	lua_getglobal(L, &#34;PrintLuaLog&#34;);</p><p data-pid="bRMP5TVW">	lua_pcall(L, 0, 0, 0);</p><p data-pid="Dj2HO-f6">//code15</p><p data-pid="rQWOL-St">	lua_settop(L, 0);</p><p data-pid="jGKmwN-A">	lua_getglobal(L, &#34;iVar&#34;);</p><p data-pid="qlodd2VG">	printf(&#34;iVar: %d\n&#34;, lua_tointeger(L, -1));</p><p class="ztext-empty-paragraph"><br/></p><p data-pid="MlvfrGKT">	lua_pop(L, 1);</p><p data-pid="5Pl-vRs6">//code16</p><p data-pid="kcIAQaRC">	lua_getglobal(L, &#34;nameTable&#34;);</p><p data-pid="A6cZv1O6">	lua_getfield(L, -1, &#34;age&#34;);</p><p class="ztext-empty-paragraph"><br/></p><p data-pid="3YynegfU">	printf(&#34;age: %d\n&#34;, lua_tointeger(L, -1));</p><p class="ztext-empty-paragraph"><br/></p><p data-pid="FNSOgHjF">	StackDump(L, 7);</p><p class="ztext-empty-paragraph"><br/></p><p data-pid="4D8Khrys">	lua_close(L);<br/></p><p data-pid="IFRPQ6mW">	printf(&#34;Press enter to exit...&#34;);</p><p data-pid="SIEf6r6z">	getchar();</p><p class="ztext-empty-paragraph"><br/></p><p data-pid="Ez1zdp2b">	return 0;</p></pre><p data-pid="eI5ymtIO">}<br/></p><h2>二、代码分析，曾经讲过的函数这里就不做分析了，不明白的，可以去看前面的文章。</h2><p data-pid="CtR29ibC"><b>code1、</b>执行lua_pop，把上面为了打印name数据而压入栈的数据弹出栈，保持栈是空的。</p><p data-pid="gvotUQeR"><b>code2、</b>用&#34;my name is lua modify &#34;的值来替换掉原来lua中name字段的值。修改规则，先压入栈内一个要修改的值value，然后调用lua_setfield，通过全局索引和key字段来进行修改要修改的key字段对应的值。修改之后会把刚才压入栈的值弹出栈。此时栈还是为空，参考栈的运行图Log index2</p><p data-pid="jayXAHPA"><b>code3、</b>打印刚才修改后的name值，确认一下是否修改成功。</p><p data-pid="V6bIzSk_"><b>code4、</b>lua_settop(L, 0)是清空栈的操作函数，无论栈中有多少元素，全部清空。</p><p data-pid="m3Ydzwg8"><b>code5、</b>开始把lua中的nameTable压如栈中等待使用。</p><p data-pid="v6LLp5H9"><b>code6、</b>code6和code7的执行效果一样，是两种获得lua table中数据的方式</p><p data-pid="Je3qlPLL"><b>code7、</b>把table中的数据压如栈中，等待使用。</p><p data-pid="g2G43rRj"><b>code8、</b>code8和code9的执行效果都是一样，都是修改table中age字段的值。我们看修改规则：先把table中的key压入栈中，然后再压入要修改的值value，最后调用lua_settable来修改。修改执行完毕会把刚才压入栈中的两个值全部弹出栈。</p><p data-pid="r1-e3xe4"><b>code9、</b>修改table中字段的值的规则，先把要修改的值压入栈中，然后调用lua_setfield来用栈顶的值修改掉原来table中的key对应的值。修改执行完毕，会把刚才压入栈中的值全部弹出。</p><p data-pid="4jDHF3Oq"><b>code10、</b>code10和code11的执行结果是一样的，都是从table中取出字段age的值，然后压入栈中。</p><p data-pid="e1gZ61B2"><b>code12、</b>是执行lua中的打印函数，来验证一下lua中的值是否被掉。</p><p data-pid="v28sQf3a"><b>code13、</b>是执行lua中的递加方法，然后看一下执行之后，lua中的各个变量的值</p><p data-pid="mj_5s3E3"><b>codd14、</b>再次打印递加之后的lua中变量的值</p><p data-pid="rc6mNDvF"><b>code15、</b>通过C++调用的方式打印lua中变量iVar的值</p><p data-pid="iA0uYTHu"><b>code16、</b>通过C++调用的方式打印lua table中的变量的值。</p><p data-pid="wOm3TCaK">所有的执行情况，可以参照栈的运行图，里面有详细的数据入栈和出栈操作</p><h2>三、运行结果如下图</h2><br><img src="v2-23c84570bd363663a2e330134463b31b_720w.jpg"width="650" height="509"><h2>四、程序运行时栈内的变化情况如下图：</h2><br><img src="v2-a129838542f33c9b6c0dccc015e1bdcb_720w.jpg"width="845" height="888">


</p>

                            </div>
                        </article>
                    </div>
                </div>
            </div>
          <footer id="colophon" role="contentinfo">
	<div id="site-generator">孙悟空 from 吉林大学自动化 @ sunwukong@sangkeji.com</div>
	<script src="../../../footer.js"></script>
          </footer>
        </div>
    </body>
</html>
