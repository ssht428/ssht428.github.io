<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <title>Lua迭代器和泛型</title>
        <link rel="stylesheet" type="text/css" media="all" href="../../../style.css">
    </head>
    <body class="post-template-default single single-post postid-14 single-format-standard logged-in admin-bar single-author singular two-column left-sidebar customize-support">
        <div id="page" class="hfeed">
            <div id="main">
                <div id="primary">
                    <div id="content" role="main">        
                        <article id="post-14" class="post-14 post type-post status-publish format-standard hentry category-18">
                            <header class="entry-header">
                                <h1 class="entry-title">Lua迭代器和泛型</h1>
                            </header>
                            <div class="entry-content">
<br><a href="../../../index.html"> Home </a> 
<br>
<br>
<p>
<span style="color: rgba(128, 0, 128, 1); font-size: 15px">&nbsp;&nbsp;&nbsp; 1. 迭代器与Closure：</span><br>&nbsp;&nbsp; &nbsp;在Lua中，迭代器通常为函数，每调用一次函数，即返回集合中的“下一个”元素。每个迭代器都需要在每次成功调用之间保持一些状态，这样才能知道它所在的位置和下一次遍历时的位置。从这一点看，Lua中closure机制为此问题提供了语言上的保障，见如下示例：</p>
<pre>
 <span style="color: rgba(0, 0, 255, 1)">function</span> values(t)<br>     <span style="color: rgba(0, 0, 255, 1)">local</span> i = <span style="color: rgba(128, 0, 128, 1)">0</span><br>     <span style="color: rgba(0, 0, 255, 1)">return</span> <span style="color: rgba(0, 0, 255, 1)">function</span>()<br>         i = i + <span style="color: rgba(128, 0, 128, 1)">1</span><br>         <span style="color: rgba(0, 0, 255, 1)">return</span> t[i]<br>     <span style="color: rgba(0, 0, 255, 1)">end</span><br> <span style="color: rgba(0, 0, 255, 1)">end</span><br> t = {<span style="color: rgba(128, 0, 128, 1)">10</span>, <span style="color: rgba(128, 0, 128, 1)">20</span>, <span style="color: rgba(128, 0, 128, 1)">30</span>}<br> it = values(t)<br> <span style="color: rgba(0, 0, 255, 1)">while</span> <span style="color: rgba(0, 0, 255, 1)">true</span> <span style="color: rgba(0, 0, 255, 1)">do</span><br>     <span style="color: rgba(0, 0, 255, 1)">local</span> element = it()<br>     <span style="color: rgba(0, 0, 255, 1)">if</span> element == <span style="color: rgba(0, 0, 255, 1)">nil</span> <span style="color: rgba(0, 0, 255, 1)">then</span><br>         <span style="color: rgba(0, 0, 255, 1)">break</span><br>     <span style="color: rgba(0, 0, 255, 1)">end</span><br>     <span style="color: rgba(255, 0, 255, 1)">print</span>(element)<br> <span style="color: rgba(0, 0, 255, 1)">end</span><br> <span style="color: rgba(0, 128, 0, 1)">--</span><span style="color: rgba(0, 128, 0, 1)">另外一种基于foreach的调用方式(泛型for)</span><span style="color: rgba(0, 128, 0, 1)"><br></span> t2 = {<span style="color: rgba(128, 0, 128, 1)">15</span>, <span style="color: rgba(128, 0, 128, 1)">25</span>, <span style="color: rgba(128, 0, 128, 1)">35</span>}<br> <span style="color: rgba(0, 0, 255, 1)">for</span> element <span style="color: rgba(0, 0, 255, 1)">in</span> values(t2) <span style="color: rgba(0, 0, 255, 1)">do</span><br>     <span style="color: rgba(255, 0, 255, 1)">print</span>(element)<br> <span style="color: rgba(0, 0, 255, 1)">end</span><br> <span style="color: rgba(0, 128, 0, 1)">--</span><span style="color: rgba(0, 128, 0, 1)">输出结果为：</span><span style="color: rgba(0, 128, 0, 1)"><br></span> <span style="color: rgba(0, 128, 0, 1)">--</span><span style="color: rgba(0, 128, 0, 1)">10</span><span style="color: rgba(0, 128, 0, 1)"><br></span> <span style="color: rgba(0, 128, 0, 1)">--</span><span style="color: rgba(0, 128, 0, 1)">20</span><span style="color: rgba(0, 128, 0, 1)"><br></span> <span style="color: rgba(0, 128, 0, 1)">--</span><span style="color: rgba(0, 128, 0, 1)">30</span><span style="color: rgba(0, 128, 0, 1)"><br></span> <span style="color: rgba(0, 128, 0, 1)">--</span><span style="color: rgba(0, 128, 0, 1)">15</span><span style="color: rgba(0, 128, 0, 1)"><br></span> <span style="color: rgba(0, 128, 0, 1)">--</span><span style="color: rgba(0, 128, 0, 1)">25</span><span style="color: rgba(0, 128, 0, 1)"><br></span> <span style="color: rgba(0, 128, 0, 1)">--</span><span style="color: rgba(0, 128, 0, 1)">35</span>
 </pre>
</div>
<p>&nbsp;&nbsp;&nbsp; 从上面的应用示例来看，相比于while方式，泛型for的方式提供了更清晰的实现逻辑。因为Lua在其内部替我们保存了迭代器函数，并在每次迭代时调用该隐式的内部迭代器，直到迭代器返回nil时结束循环。<br><br><span style="color: rgba(128, 0, 128, 1); font-size: 15px">&nbsp;&nbsp; &nbsp;2. 泛型for的语义：</span><br>&nbsp;&nbsp; &nbsp;上面示例中的迭代器有一个明显的缺点，即每次循环时都需要创建一个新的closure变量，否则第一次迭代成功后，再将该closure用于新的for循环时将会直接退出。<br>&nbsp;&nbsp; &nbsp;这里我们还是先详细的讲解一下Lua中泛型(for)的机制，之后再给出一个无状态迭代器的例子，以便于我们的理解。如果我们的迭代器实现为无状态迭代器，那么就不必为每一次的泛型(for)都重新声明一个新的迭代器变量了。<br>&nbsp;&nbsp; &nbsp;泛型(for)的语法如下：<br><span style="color: rgba(0, 0, 255, 1)">&nbsp;&nbsp; &nbsp;for &lt;var-list&gt; in &lt;exp-list&gt; do</span><br><span style="color: rgba(0, 0, 255, 1)">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&lt;body&gt;</span><br><span style="color: rgba(0, 0, 255, 1)">&nbsp;&nbsp; &nbsp;end</span><br>&nbsp;&nbsp; &nbsp;为了便于理解，由于我们在实际应用中<span style="color: rgba(0, 0, 255, 1)">&lt;exp-list&gt;</span>通常只是包含一个表达式(expr)，因此简单起见，这里的说明将只是包含一个表达式，而不是表达式列表。现在我们先给出表达式的原型和实例，如：</p>
<div class="cnblogs_code">
<pre> <span style="color: rgba(0, 0, 255, 1)">function</span> ipairs2(a)<br>     <span style="color: rgba(0, 0, 255, 1)">return</span> iter,a,<span style="color: rgba(128, 0, 128, 1)">0</span><br> <span style="color: rgba(0, 0, 255, 1)">end</span></pre>
</div>
<p>&nbsp;&nbsp;&nbsp; 该函数返回3个值，第一个为实际的迭代器函数变量，第二个是一个恒定对象，这里我们可以理解为待遍历的容器，第三个变量是在调用iter()函数时为其传入的初始值。<br>&nbsp;&nbsp; &nbsp;下面我们再看一下iter()函数的实现，如：</p>
<div class="cnblogs_code">
<pre> <span style="color: rgba(0, 0, 255, 1)">local</span> <span style="color: rgba(0, 0, 255, 1)">function</span> iter(a, i)<br>     i = i + <span style="color: rgba(128, 0, 128, 1)">1</span><br>     <span style="color: rgba(0, 0, 255, 1)">local</span> v = a[i]<br>     <span style="color: rgba(0, 0, 255, 1)">if</span> v <span style="color: rgba(0, 0, 255, 1)">then</span><br>         <span style="color: rgba(0, 0, 255, 1)">return</span> i, v<br>     <span style="color: rgba(0, 0, 255, 1)">else</span><br>         <span style="color: rgba(0, 0, 255, 1)">return</span> <span style="color: rgba(0, 0, 255, 1)">nil</span>, <span style="color: rgba(0, 0, 255, 1)">nil</span><br>     <span style="color: rgba(0, 0, 255, 1)">end</span><br> <span style="color: rgba(0, 0, 255, 1)">end</span></pre>
</div>
<p>&nbsp;&nbsp;&nbsp; 在迭代器函数iter()中返回了两个值，分别对应于table的key和value，其中key(返回的i)如果为nil，泛型(for)将会认为本次迭代已经结束。下面我们先看一下实际用例，如：</p>
<div class="cnblogs_code">
<pre> <span style="color: rgba(0, 0, 255, 1)">function</span> ipairs2(a)<br>     <span style="color: rgba(0, 0, 255, 1)">return</span> iter,a,<span style="color: rgba(128, 0, 128, 1)">0</span><br> <span style="color: rgba(0, 0, 255, 1)">end</span><br> <br> <br> <span style="color: rgba(0, 0, 255, 1)">local</span> <span style="color: rgba(0, 0, 255, 1)">function</span> iter(a, i)<br>     i = i + <span style="color: rgba(128, 0, 128, 1)">1</span><br>     <span style="color: rgba(0, 0, 255, 1)">local</span> v = a[i]<br>     <span style="color: rgba(0, 0, 255, 1)">if</span> v <span style="color: rgba(0, 0, 255, 1)">then</span><br>         <span style="color: rgba(0, 0, 255, 1)">return</span> i, v<br>     <span style="color: rgba(0, 0, 255, 1)">else</span><br>         <span style="color: rgba(0, 0, 255, 1)">return</span> <span style="color: rgba(0, 0, 255, 1)">nil</span>, <span style="color: rgba(0, 0, 255, 1)">nil</span><br>     <span style="color: rgba(0, 0, 255, 1)">end</span><br> <span style="color: rgba(0, 0, 255, 1)">end</span><br> <br> a = {<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">one</span><span style="color: rgba(128, 0, 0, 1)">"</span>,<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">two</span><span style="color: rgba(128, 0, 0, 1)">"</span>,<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">three</span><span style="color: rgba(128, 0, 0, 1)">"</span>}<br> <span style="color: rgba(0, 0, 255, 1)">for</span> k,v <span style="color: rgba(0, 0, 255, 1)">in</span> ipairs2(a) <span style="color: rgba(0, 0, 255, 1)">do</span><br>     <span style="color: rgba(255, 0, 255, 1)">print</span>(k, v)<br> <span style="color: rgba(0, 0, 255, 1)">end</span><br> <span style="color: rgba(0, 128, 0, 1)">--</span><span style="color: rgba(0, 128, 0, 1)">输出结果为：</span><span style="color: rgba(0, 128, 0, 1)"><br></span> <span style="color: rgba(0, 128, 0, 1)">--</span><span style="color: rgba(0, 128, 0, 1)">1       one</span><span style="color: rgba(0, 128, 0, 1)"><br></span> <span style="color: rgba(0, 128, 0, 1)">--</span><span style="color: rgba(0, 128, 0, 1)">2       two</span><span style="color: rgba(0, 128, 0, 1)"><br></span> <span style="color: rgba(0, 128, 0, 1)">--</span><span style="color: rgba(0, 128, 0, 1)">3       three    </span></pre>
</div>
<p>&nbsp;&nbsp;&nbsp; 这个例子中的泛型(for)写法可以展开为下面的基于while循环的方式，如：</p>
<div class="cnblogs_code">
<pre> <span style="color: rgba(0, 0, 255, 1)">local</span> <span style="color: rgba(0, 0, 255, 1)">function</span> iter(a, i)<br>     i = i + <span style="color: rgba(128, 0, 128, 1)">1</span><br>     <span style="color: rgba(0, 0, 255, 1)">local</span> v = a[i]<br>     <span style="color: rgba(0, 0, 255, 1)">if</span> v <span style="color: rgba(0, 0, 255, 1)">then</span><br>         <span style="color: rgba(0, 0, 255, 1)">return</span> i, v<br>     <span style="color: rgba(0, 0, 255, 1)">else</span><br>         <span style="color: rgba(0, 0, 255, 1)">return</span> <span style="color: rgba(0, 0, 255, 1)">nil</span>, <span style="color: rgba(0, 0, 255, 1)">nil</span><br>     <span style="color: rgba(0, 0, 255, 1)">end</span><br> <span style="color: rgba(0, 0, 255, 1)">end</span><br> <br> <span style="color: rgba(0, 0, 255, 1)">function</span> ipairs2(a)<br>     <span style="color: rgba(0, 0, 255, 1)">return</span> iter,a,<span style="color: rgba(128, 0, 128, 1)">0</span><br> <span style="color: rgba(0, 0, 255, 1)">end</span><br> <br> a = {<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">one</span><span style="color: rgba(128, 0, 0, 1)">"</span>,<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">two</span><span style="color: rgba(128, 0, 0, 1)">"</span>,<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">three</span><span style="color: rgba(128, 0, 0, 1)">"</span>}<br> <span style="color: rgba(0, 0, 255, 1)">do</span><br>     <span style="color: rgba(0, 0, 255, 1)">local</span> <span style="color: rgba(0, 128, 128, 1)">_it</span>,,<span style="color: rgba(0, 128, 128, 1)">_var</span> = ipairs2(a)<br>     <span style="color: rgba(0, 0, 255, 1)">while</span> <span style="color: rgba(0, 0, 255, 1)">true</span> <span style="color: rgba(0, 0, 255, 1)">do</span><br>         <span style="color: rgba(0, 0, 255, 1)">local</span> var_1,var_2 = <span style="color: rgba(0, 128, 128, 1)">_it</span>(,<span style="color: rgba(0, 128, 128, 1)">_var</span>)<br>         <span style="color: rgba(0, 128, 128, 1)">_var</span> = var_1<br>         <span style="color: rgba(0, 0, 255, 1)">if</span> <span style="color: rgba(0, 128, 128, 1)">_var</span> == <span style="color: rgba(0, 0, 255, 1)">nil</span> <span style="color: rgba(0, 0, 255, 1)">then</span>  <span style="color: rgba(0, 128, 0, 1)">--</span><span style="color: rgba(0, 128, 0, 1)">注意，这里只判断迭代器函数返回的第一个是否为nil。</span><span style="color: rgba(0, 128, 0, 1)"><br></span>             <span style="color: rgba(0, 0, 255, 1)">break</span><br>         <span style="color: rgba(0, 0, 255, 1)">end</span><br>         <span style="color: rgba(255, 0, 255, 1)">print</span>(var_1,var_2)<br>     <span style="color: rgba(0, 0, 255, 1)">end</span><br> <span style="color: rgba(0, 0, 255, 1)">end</span><br> <span style="color: rgba(0, 128, 0, 1)">--</span><span style="color: rgba(0, 128, 0, 1)">输出结果同上。</span></pre>
</div>
<p><br>&nbsp;&nbsp;&nbsp; <span style="color: rgba(128, 0, 128, 1); font-size: 15px">3. 无状态迭代器的例子：</span><br>&nbsp;&nbsp;&nbsp; 这里的示例将实现遍历链表的迭代器。</p>
<div class="cnblogs_code">
<pre> <span style="color: rgba(0, 0, 255, 1)">local</span> <span style="color: rgba(0, 0, 255, 1)">function</span> getnext(list, node)  <span style="color: rgba(0, 128, 0, 1)">--</span><span style="color: rgba(0, 128, 0, 1)">迭代器函数。</span><span style="color: rgba(0, 128, 0, 1)"><br></span>     <span style="color: rgba(0, 0, 255, 1)">if</span> <span style="color: rgba(0, 0, 255, 1)">not</span> node <span style="color: rgba(0, 0, 255, 1)">then</span><br>         <span style="color: rgba(0, 0, 255, 1)">return</span> list<br>     <span style="color: rgba(0, 0, 255, 1)">else</span><br>         <span style="color: rgba(0, 0, 255, 1)">return</span> node.<span style="color: rgba(255, 0, 255, 1)">next</span><br>     <span style="color: rgba(0, 0, 255, 1)">end</span><br> <span style="color: rgba(0, 0, 255, 1)">end</span><br> <br> <span style="color: rgba(0, 0, 255, 1)">function</span> traverse(list)  <span style="color: rgba(0, 128, 0, 1)">--</span><span style="color: rgba(0, 128, 0, 1)">泛型(for)的expression</span><span style="color: rgba(0, 128, 0, 1)"><br></span>     <span style="color: rgba(0, 0, 255, 1)">return</span> getnext,list,<span style="color: rgba(0, 0, 255, 1)">nil</span><br> <span style="color: rgba(0, 0, 255, 1)">end</span><br> <br> <span style="color: rgba(0, 128, 0, 1)">--</span><span style="color: rgba(0, 128, 0, 1)">初始化链表中的数据。</span><span style="color: rgba(0, 128, 0, 1)"><br></span> list = <span style="color: rgba(0, 0, 255, 1)">nil</span><br> <span style="color: rgba(0, 0, 255, 1)">for</span> line <span style="color: rgba(0, 0, 255, 1)">in</span> <span style="color: rgba(255, 0, 255, 1)">io.lines</span>() <span style="color: rgba(0, 0, 255, 1)">do</span><br>     line = { val = line, <span style="color: rgba(255, 0, 255, 1)">next</span> = list}<br> <span style="color: rgba(0, 0, 255, 1)">end</span><br> <br> <span style="color: rgba(0, 128, 0, 1)">--</span><span style="color: rgba(0, 128, 0, 1)">以泛型(for)的形式遍历链表。</span><span style="color: rgba(0, 128, 0, 1)"><br></span> <span style="color: rgba(0, 0, 255, 1)">for</span> node <span style="color: rgba(0, 0, 255, 1)">in</span> traverse(list) <span style="color: rgba(0, 0, 255, 1)">do</span><br>     <span style="color: rgba(255, 0, 255, 1)">print</span>(node.val)<br> <span style="color: rgba(0, 0, 255, 1)">end</span></pre>
</div>
<p>&nbsp;&nbsp;&nbsp; 这里使用的技巧是将链表的头结点作为恒定状态(traverse返回的第二个值)，而将当前节点作为控制变量。第一次调用迭代器函数getnext()时，node为nil，因此函数返回list作为第一个结点。在后续调用中node不再为nil了，所以迭代器返回node.next，直到返回链表尾部的nil结点，此时泛型(for)将判断出迭代器的遍历已经结束。<br>&nbsp;&nbsp; &nbsp;最后需要说明的是，traverse()函数和list变量可以反复的调用而无需再创建新的closure变量了。这主要是因为迭代器函数(getnext)实现为无状态迭代器。<br><br><span style="color: rgba(128, 0, 128, 1); font-size: 15px">&nbsp;&nbsp;&nbsp; 4. 具有复杂状态的迭代器：</span><br>&nbsp;&nbsp; &nbsp;在上面介绍的迭代器实现中，迭代器需要保存许多状态，可是泛型(for)却只提供了恒定状态和控制变量用于状态的保存。一个最简单的办法是使用closure。当然我们还以将所有的信息封装到一个table中，并作为恒定状态对象传递给迭代器。虽说恒定状态变量本身是恒定的，即在迭代过程中不会换成其它对象，但是该对象所包含的数据是否变化则完全取决于迭代器的实现。就目前而言，由于table类型的恒定对象已经包含了所有迭代器依赖的信息，那么迭代器就完全可以忽略泛型(for)提供的第二个参数。下面我们就给出一个这样的实例，见如下代码：</p>
<div class="cnblogs_code">
<pre> <span style="color: rgba(0, 0, 255, 1)">local</span> iterator<br> <span style="color: rgba(0, 0, 255, 1)">function</span> allwords()<br>     <span style="color: rgba(0, 0, 255, 1)">local</span> state { line = <span style="color: rgba(255, 0, 255, 1)">io.read</span>(), pos = <span style="color: rgba(128, 0, 128, 1)">1</span> }<br>     <span style="color: rgba(0, 0, 255, 1)">return</span> iterator, state<br> <span style="color: rgba(0, 0, 255, 1)">end</span><br> <span style="color: rgba(0, 128, 0, 1)">--</span><span style="color: rgba(0, 128, 0, 1)">iterator函数将是真正的迭代器</span><span style="color: rgba(0, 128, 0, 1)"><br></span> <span style="color: rgba(0, 0, 255, 1)">function</span> iterator(state)<br>     <span style="color: rgba(0, 0, 255, 1)">while</span> state.line <span style="color: rgba(0, 0, 255, 1)">do</span><br>         <span style="color: rgba(0, 0, 255, 1)">local</span> s,e = <span style="color: rgba(255, 0, 255, 1)">string.find</span>(state.line,<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">%w+</span><span style="color: rgba(128, 0, 0, 1)">"</span>,state.pos)<br>         <span style="color: rgba(0, 0, 255, 1)">if</span> s <span style="color: rgba(0, 0, 255, 1)">then</span><br>             state.pos = e + <span style="color: rgba(128, 0, 128, 1)">1</span><br>             <span style="color: rgba(0, 0, 255, 1)">return</span> <span style="color: rgba(255, 0, 255, 1)">string.sub</span>(state.line,s,e)<br>         <span style="color: rgba(0, 0, 255, 1)">else</span><br>             state.line = <span style="color: rgba(255, 0, 255, 1)">io.read</span>()<br>             state.pos = <span style="color: rgba(128, 0, 128, 1)">1</span><br>         <span style="color: rgba(0, 0, 255, 1)">end</span><br>     <span style="color: rgba(0, 0, 255, 1)">end</span><br>     <span style="color: rgba(0, 0, 255, 1)">return</span> <span style="color: rgba(0, 0, 255, 1)">nil</span><br> <span style="color: rgba(0, 0, 255, 1)">end</span></pre>

</p>

                            </div>
                        </article>
                    </div>
                </div>
            </div>
          <footer id="colophon" role="contentinfo">
	<div id="site-generator">孙悟空 from 吉林大学自动化 @ sunwukong@sangkeji.com</div>
	<script src="../../../footer.js"></script>
          </footer>
        </div>
    </body>
</html>
