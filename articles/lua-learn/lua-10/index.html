<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <title>Lua环境</title>
        <link rel="stylesheet" type="text/css" media="all" href="../../../style.css">
    </head>
    <body class="post-template-default single single-post postid-14 single-format-standard logged-in admin-bar single-author singular two-column left-sidebar customize-support">
        <div id="page" class="hfeed">
            <div id="main">
                <div id="primary">
                    <div id="content" role="main">        
                        <article id="post-14" class="post-14 post type-post status-publish format-standard hentry category-18">
                            <header class="entry-header">
                                <h1 class="entry-title">Lua环境</h1>
                            </header>
                            <div class="entry-content">
<br><a href="../../../index.html"> Home </a> 
<br>
<br>
<p>
&nbsp;&nbsp;&nbsp; Lua将其所有的全局变量保存在一个常规的table中，这个table被称为“环境”。它被保存在全局变量<strong><span style="color: rgba(0, 0, 255, 1)">_G</span></strong>中。<br><span style="color: rgba(128, 0, 128, 1); font-size: 15px">&nbsp;&nbsp; &nbsp;1. 全局变量声明：</span><br>&nbsp;&nbsp; &nbsp;Lua中的全局变量不需要声明就可以使用。尽管很方便，但是一旦出现笔误就会造成难以发现的错误。我们可以通过给_G表加元表的方式来保护全局变量的读取和设置，这样就能降低这种笔误问题的发生几率了。见如下示例代码：</p>

<pre> <span style="color: rgba(0, 128, 0, 1)">--</span><span style="color: rgba(0, 128, 0, 1)">该table用于存储所有已经声明过的全局变量名</span><span style="color: rgba(0, 128, 0, 1)"><br></span> <span style="color: rgba(0, 0, 255, 1)">local</span> declaredNames = {} <br> <span style="color: rgba(0, 0, 255, 1)">local</span> mt = {<br>     __newindex = <span style="color: rgba(0, 0, 255, 1)">function</span>(table,name,value)<br>         <span style="color: rgba(0, 128, 0, 1)">--</span><span style="color: rgba(0, 128, 0, 1)">先检查新的名字是否已经声明过，如果存在，这直接通过rawset函数设置即可。</span><span style="color: rgba(0, 128, 0, 1)"><br></span>         <span style="color: rgba(0, 0, 255, 1)">if</span> <span style="color: rgba(0, 0, 255, 1)">not</span> declaredNames[name] <span style="color: rgba(0, 0, 255, 1)">then</span><br>             <span style="color: rgba(0, 128, 0, 1)">--</span><span style="color: rgba(0, 128, 0, 1)">再检查本次操作是否是在主程序或者C代码中完成的，如果是，就继续设置，否则报错。</span><span style="color: rgba(0, 128, 0, 1)"><br></span>             <span style="color: rgba(0, 0, 255, 1)">local</span> w = <span style="color: rgba(255, 0, 255, 1)">debug.getinfo</span>(<span style="color: rgba(128, 0, 128, 1)">2</span>,<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">S</span><span style="color: rgba(128, 0, 0, 1)">"</span>).what<br>             <span style="color: rgba(0, 0, 255, 1)">if</span> w ~= <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">main</span><span style="color: rgba(128, 0, 0, 1)">"</span> <span style="color: rgba(0, 0, 255, 1)">and</span> w ~= <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">C</span><span style="color: rgba(128, 0, 0, 1)">"</span> <span style="color: rgba(0, 0, 255, 1)">then</span><br>                 <span style="color: rgba(255, 0, 255, 1)">error</span>(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">attempt to write to undeclared variable </span><span style="color: rgba(128, 0, 0, 1)">"</span> .. name)<br>             <span style="color: rgba(0, 0, 255, 1)">end</span><br>             <span style="color: rgba(0, 128, 0, 1)">--</span><span style="color: rgba(0, 128, 0, 1)">在实际设置之前，更新一下declaredNames表，下次再设置时就无需检查了。</span><span style="color: rgba(0, 128, 0, 1)"><br></span>             declaredNames[name] = <span style="color: rgba(0, 0, 255, 1)">true</span><br>         <span style="color: rgba(0, 0, 255, 1)">end</span><br>         <span style="color: rgba(255, 0, 255, 1)">print</span>(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">Setting </span><span style="color: rgba(128, 0, 0, 1)">"</span> .. name .. <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)"> to </span><span style="color: rgba(128, 0, 0, 1)">"</span> .. value)<br>         <span style="color: rgba(255, 0, 255, 1)">rawset</span>(table,name,value)<br>     <span style="color: rgba(0, 0, 255, 1)">end</span>,<br>     <br>     __index = <span style="color: rgba(0, 0, 255, 1)">function</span>(_,name)<br>         <span style="color: rgba(0, 0, 255, 1)">if</span> <span style="color: rgba(0, 0, 255, 1)">not</span> declaredNames[name] <span style="color: rgba(0, 0, 255, 1)">then</span><br>             <span style="color: rgba(255, 0, 255, 1)">error</span>(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">attempt to read undeclared variable </span><span style="color: rgba(128, 0, 0, 1)">"</span> .. name)<br>         <span style="color: rgba(0, 0, 255, 1)">else</span><br>             <span style="color: rgba(0, 0, 255, 1)">return</span> <span style="color: rgba(255, 0, 255, 1)">rawget</span>(_,name)<br>         <span style="color: rgba(0, 0, 255, 1)">end</span><br>     <span style="color: rgba(0, 0, 255, 1)">end</span><br> }    <br> <span style="color: rgba(255, 0, 255, 1)">setmetatable</span>(,mt)<br> <br> a = <span style="color: rgba(128, 0, 128, 1)">11</span><br> <span style="color: rgba(0, 0, 255, 1)">local</span> kk = aa<br> <br> <span style="color: rgba(0, 128, 0, 1)">--</span><span style="color: rgba(0, 128, 0, 1)">输出结果为：</span><span style="color: rgba(0, 128, 0, 1)"><br></span> <span style="color: rgba(0, 128, 0, 1)">--[[</span><span style="color: rgba(0, 128, 0, 1)"><br></span> <span style="color: rgba(0, 128, 0, 1)">Setting a to 11<br></span> <span style="color: rgba(0, 128, 0, 1)">lua: d:/test.lua:21: attempt to read undeclared variable aa<br></span> <span style="color: rgba(0, 128, 0, 1)">stack traceback:<br></span> <span style="color: rgba(0, 128, 0, 1)">        [C]: in function 'error'<br></span> <span style="color: rgba(0, 128, 0, 1)">        d:/test.lua:21: in function &lt;d:/test.lua:19&gt;<br></span> <span style="color: rgba(0, 128, 0, 1)">        d:/test.lua:30: in main chunk<br></span> <span style="color: rgba(0, 128, 0, 1)">        [C]: ?<br></span> <span style="color: rgba(0, 128, 0, 1)">--</span><span style="color: rgba(0, 128, 0, 1)">]]</span></pre>

<p><br><span style="color: rgba(128, 0, 128, 1); font-size: 15px">&nbsp;&nbsp;&nbsp; 2. 非全局的环境：</span><br>&nbsp;&nbsp; &nbsp;全局环境存在一个刚性的问题，即它的修改将影响到程序的所有部分。Lua 5为此做了一些改进，新的特征可以支持每个函数拥有自己独立的全局环境，而由该函数创建的closure函数将继承该函数的全局变量表。这里我们可以通过setfenv函数来改变一个函数的环境，该函数接受两个参数，一个是函数名，另一个是新的环境table。第一个参数除了函数名本身，还可以指定为一个数字，以表示当前函数调用栈中的层数。数字1表示当前函数，2表示它的调用函数，以此类推。见如下代码：</p>

<pre> a = <span style="color: rgba(128, 0, 128, 1)">1</span><br> <span style="color: rgba(255, 0, 255, 1)">setfenv</span>(<span style="color: rgba(128, 0, 128, 1)">1</span>,{})<br> <span style="color: rgba(255, 0, 255, 1)">print</span>(a)<br> <br> <span style="color: rgba(0, 128, 0, 1)">--</span><span style="color: rgba(0, 128, 0, 1)">输出结果为：</span><span style="color: rgba(0, 128, 0, 1)"><br></span> <span style="color: rgba(0, 128, 0, 1)">--[[</span><span style="color: rgba(0, 128, 0, 1)"><br></span> <span style="color: rgba(0, 128, 0, 1)">lua: d:/test.lua:3: attempt to call global 'print' (a nil value)<br></span> <span style="color: rgba(0, 128, 0, 1)">stack traceback:<br></span> <span style="color: rgba(0, 128, 0, 1)">        d:/test.lua:3: in main chunk<br></span> <span style="color: rgba(0, 128, 0, 1)">        [C]: ?<br></span> <span style="color: rgba(0, 128, 0, 1)">--</span><span style="color: rgba(0, 128, 0, 1)">]]</span></pre>

<p>&nbsp;&nbsp;&nbsp; 为什么得到这样的结果呢？因为print和变量a一样，都是全局表中的字段，而新的全局表是空的，所以print调用将会报错。<br>&nbsp;&nbsp;&nbsp; 为了应对这一副作用，我们可以让原有的全局表_G作为新全局表的内部表，在访问已有全局变量时，可以直接转到_G中的字段，而对于新的全局字段，则保留在新的全局表中。这样即便是函数中的误修改，也不会影响到其他用到全局变量(_G)的地方。见如下代码：</p>

<pre> a = <span style="color: rgba(128, 0, 128, 1)">1</span><br> <span style="color: rgba(0, 0, 255, 1)">local</span> newgt = {}  <span style="color: rgba(0, 128, 0, 1)">--</span><span style="color: rgba(0, 128, 0, 1)">新环境表</span><span style="color: rgba(0, 128, 0, 1)"><br></span> <span style="color: rgba(255, 0, 255, 1)">setmetatable</span>(newgt,{__index = })<br> <span style="color: rgba(255, 0, 255, 1)">setfenv</span>(<span style="color: rgba(128, 0, 128, 1)">1</span>,newgt)<br> <span style="color: rgba(255, 0, 255, 1)">print</span>(a)  <span style="color: rgba(0, 128, 0, 1)">--</span><span style="color: rgba(0, 128, 0, 1)">输出1</span><span style="color: rgba(0, 128, 0, 1)"><br></span> <br> a = <span style="color: rgba(128, 0, 128, 1)">10</span><br> <span style="color: rgba(255, 0, 255, 1)">print</span>(a)  <span style="color: rgba(0, 128, 0, 1)">--</span><span style="color: rgba(0, 128, 0, 1)">输出10</span><span style="color: rgba(0, 128, 0, 1)"><br></span> <span style="color: rgba(255, 0, 255, 1)">print</span>(.a) <span style="color: rgba(0, 128, 0, 1)">--</span><span style="color: rgba(0, 128, 0, 1)">输出1</span><span style="color: rgba(0, 128, 0, 1)"><br></span> .a = <span style="color: rgba(128, 0, 128, 1)">20</span><br> <span style="color: rgba(255, 0, 255, 1)">print</span>(a)  <span style="color: rgba(0, 128, 0, 1)">--</span><span style="color: rgba(0, 128, 0, 1)">输出10</span></pre>

<p>&nbsp;&nbsp;&nbsp; 最后给出的示例是函数环境变量的继承性。见如下代码：</p>

<pre> <span style="color: rgba(0, 0, 255, 1)">function</span> factory()<br>     <span style="color: rgba(0, 0, 255, 1)">return</span> <span style="color: rgba(0, 0, 255, 1)">function</span>() <span style="color: rgba(0, 0, 255, 1)">return</span> a <span style="color: rgba(0, 0, 255, 1)">end</span><br> <span style="color: rgba(0, 0, 255, 1)">end</span><br> a = <span style="color: rgba(128, 0, 128, 1)">3</span><br> f1 = factory()<br> f2 = factory()<br> <span style="color: rgba(255, 0, 255, 1)">print</span>(f1())  <span style="color: rgba(0, 128, 0, 1)">--</span><span style="color: rgba(0, 128, 0, 1)">输出3</span><span style="color: rgba(0, 128, 0, 1)"><br></span> <span style="color: rgba(255, 0, 255, 1)">print</span>(f2())  <span style="color: rgba(0, 128, 0, 1)">--</span><span style="color: rgba(0, 128, 0, 1)">输出3</span><span style="color: rgba(0, 128, 0, 1)"><br></span> <br> <span style="color: rgba(255, 0, 255, 1)">setfenv</span>(f1,{a = <span style="color: rgba(128, 0, 128, 1)">10</span>})<br> <span style="color: rgba(255, 0, 255, 1)">print</span>(f1())  <span style="color: rgba(0, 128, 0, 1)">--</span><span style="color: rgba(0, 128, 0, 1)">输出10</span><span style="color: rgba(0, 128, 0, 1)"><br></span> <span style="color: rgba(255, 0, 255, 1)">print</span>(f2())  <span style="color: rgba(0, 128, 0, 1)">--</span><span style="color: rgba(0, 128, 0, 1)">输出3</span></pre>


</p>

                            </div>
                        </article>
                    </div>
                </div>
            </div>
          <footer id="colophon" role="contentinfo">
	<div id="site-generator">孙悟空 from 吉林大学自动化 @ sunwukong@sangkeji.com</div>
	<script src="../../../footer.js"></script>
          </footer>
        </div>
    </body>
</html>
